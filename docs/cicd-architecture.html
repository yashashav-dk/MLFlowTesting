<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Architecture & Flow Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h2 .emoji {
            font-size: 1.8rem;
        }
        .description {
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .mermaid {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .concept-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #00d4ff;
        }
        .concept-card h3 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .concept-card p {
            color: #999;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .command-box {
            background: #0d1117;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            border: 1px solid #30363d;
        }
        .command-box code {
            color: #58a6ff;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .toc {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
        }
        .toc h3 {
            color: #00d4ff;
            margin-bottom: 15px;
        }
        .toc ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .toc a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 5px 0;
            display: block;
            transition: color 0.2s;
        }
        .toc a:hover {
            color: #00d4ff;
        }
        .toc a::before {
            content: "‚Üí ";
            color: #7b2cbf;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CI/CD Pipeline Architecture</h1>
        <p class="subtitle">Complete Local CI/CD with Docker, Prometheus & Grafana</p>

        <!-- Table of Contents -->
        <div class="toc">
            <h3>Contents</h3>
            <ul>
                <li><a href="#overview">Complete Pipeline Overview</a></li>
                <li><a href="#architecture">System Architecture</a></li>
                <li><a href="#ci-flow">CI: Continuous Integration</a></li>
                <li><a href="#cd-flow">CD: Continuous Deployment</a></li>
                <li><a href="#docker-flow">Docker Container Flow</a></li>
                <li><a href="#monitoring">Monitoring Stack</a></li>
                <li><a href="#concepts">Key Concepts</a></li>
            </ul>
        </div>

        <!-- 1. Complete Pipeline Overview -->
        <div class="section" id="overview">
            <h2><span class="emoji">üîÑ</span> Complete CI/CD Pipeline</h2>
            <p class="description">
                The full pipeline from code change to production deployment. Each step must pass before proceeding to the next.
            </p>
            <div class="mermaid">
flowchart LR
    subgraph CI ["üîç Continuous Integration"]
        A[("üë®‚Äçüíª\nDeveloper\nCode")] --> B["üìù\nLint\n(ruff)"]
        B --> C["üß™\nTest\n(pytest)"]
    end

    subgraph CD ["üöÄ Continuous Deployment"]
        C --> D["üê≥\nBuild\n(Docker)"]
        D --> E["üì¶\nPush\n(Registry)"]
        E --> F["üåê\nDeploy\n(Compose)"]
    end

    F --> G[("‚úÖ\nProduction\nRunning")]

    style A fill:#e1bee7,stroke:#7b2cbf,color:#000
    style B fill:#fff3e0,stroke:#ff9800,color:#000
    style C fill:#e3f2fd,stroke:#2196f3,color:#000
    style D fill:#e0f2f1,stroke:#009688,color:#000
    style E fill:#fce4ec,stroke:#e91e63,color:#000
    style F fill:#e8f5e9,stroke:#4caf50,color:#000
    style G fill:#c8e6c9,stroke:#2e7d32,color:#000
            </div>
            <div class="command-box">
                <code>make all</code> ‚Üí Runs the complete pipeline (lint ‚Üí test ‚Üí build ‚Üí push ‚Üí deploy)
            </div>
        </div>

        <!-- 2. System Architecture -->
        <div class="section" id="architecture">
            <h2><span class="emoji">üèóÔ∏è</span> System Architecture</h2>
            <p class="description">
                How all components connect: ML API serves predictions, Prometheus scrapes metrics, Grafana visualizes them.
            </p>
            <div class="mermaid">
flowchart TB
    subgraph DEV ["üíª Development Environment"]
        CODE["üìÅ Source Code\n(Python/FastAPI)"]
        MAKE["‚öôÔ∏è Makefile\n(CI/CD Commands)"]
    end

    subgraph REGISTRY ["üì¶ Local Registry (localhost:5050)"]
        IMG["üê≥ Docker Images\n- ml-api:latest\n- ml-api:commit-sha"]
    end

    subgraph RUNTIME ["üñ•Ô∏è Docker Runtime"]
        subgraph COMPOSE ["docker-compose.yml"]
            API["ü§ñ ML API\n:8000"]
            PROM["üìä Prometheus\n:9090"]
            GRAF["üìà Grafana\n:3000"]
        end
    end

    subgraph ENDPOINTS ["üåê Exposed Endpoints"]
        E1["GET /health"]
        E2["POST /predict"]
        E3["GET /metrics"]
        E4["GET /docs"]
    end

    CODE --> |"make build"| IMG
    IMG --> |"make deploy"| API

    API --> E1
    API --> E2
    API --> E3
    API --> E4

    API --> |"metrics scrape\nevery 15s"| PROM
    PROM --> |"data source"| GRAF

    style CODE fill:#e1bee7,stroke:#7b2cbf,color:#000
    style MAKE fill:#fff3e0,stroke:#ff9800,color:#000
    style IMG fill:#e0f2f1,stroke:#009688,color:#000
    style API fill:#e3f2fd,stroke:#2196f3,color:#000
    style PROM fill:#fce4ec,stroke:#e91e63,color:#000
    style GRAF fill:#e8f5e9,stroke:#4caf50,color:#000
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e3f2fd;"></div>
                    <span>ML API (FastAPI)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fce4ec;"></div>
                    <span>Prometheus (Metrics DB)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e8f5e9;"></div>
                    <span>Grafana (Visualization)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e0f2f1;"></div>
                    <span>Docker Registry</span>
                </div>
            </div>
        </div>

        <!-- 3. CI Flow -->
        <div class="section" id="ci-flow">
            <h2><span class="emoji">üîç</span> Continuous Integration (CI)</h2>
            <p class="description">
                CI ensures code quality before deployment. Linting catches style issues, testing catches bugs.
            </p>
            <div class="mermaid">
flowchart TD
    subgraph LINT ["Step 1: Linting (make lint)"]
        L1["üîç ruff check .\nFind code issues"] --> L2{"Errors?"}
        L2 --> |"Yes"| L3["‚ùå Fix Issues"]
        L3 --> L1
        L2 --> |"No"| L4["‚úÖ Lint Passed"]

        L4 --> L5["üé® ruff format --check\nCheck formatting"]
        L5 --> L6{"Formatted?"}
        L6 --> |"No"| L7["Run: ruff format ."]
        L7 --> L5
        L6 --> |"Yes"| L8["‚úÖ Format OK"]
    end

    subgraph TEST ["Step 2: Testing (make test)"]
        L8 --> T1["üì¶ Install Dependencies\npip install -r requirements.txt"]
        T1 --> T2["üß™ Run pytest\n19 unit tests"]
        T2 --> T3{"All Pass?"}
        T3 --> |"No"| T4["‚ùå Fix Tests"]
        T4 --> T2
        T3 --> |"Yes"| T5["‚úÖ CI Complete!"]
    end

    style L1 fill:#fff3e0,stroke:#ff9800,color:#000
    style L8 fill:#c8e6c9,stroke:#4caf50,color:#000
    style T2 fill:#e3f2fd,stroke:#2196f3,color:#000
    style T5 fill:#c8e6c9,stroke:#4caf50,color:#000
            </div>
            <div class="command-box">
                <code>make ci</code> ‚Üí Runs lint + test
            </div>
        </div>

        <!-- 4. CD Flow -->
        <div class="section" id="cd-flow">
            <h2><span class="emoji">üöÄ</span> Continuous Deployment (CD)</h2>
            <p class="description">
                CD automates getting tested code into production. Build once, deploy anywhere.
            </p>
            <div class="mermaid">
flowchart TD
    subgraph BUILD ["Step 3: Build (make build)"]
        B1["üìÅ Source Code"] --> B2["üê≥ docker build"]
        B2 --> B3["üì¶ Image Created\nlocalhost:5050/ml-api:abc123"]
    end

    subgraph PUSH ["Step 4: Push (make push)"]
        B3 --> P1["üì§ docker push"]
        P1 --> P2["üì¶ Registry Updated\nlocalhost:5050"]
        P2 --> P3["üè∑Ô∏è Tagged:\n- :latest\n- :commit-sha"]
    end

    subgraph DEPLOY ["Step 5: Deploy (make deploy)"]
        P3 --> D1["üì• docker pull\n(from registry)"]
        D1 --> D2["üîÑ docker-compose\nup -d --force-recreate"]
        D2 --> D3["‚è≥ Wait for\nHealth Check"]
        D3 --> D4{"Healthy?"}
        D4 --> |"Yes"| D5["‚úÖ Deployed!"]
        D4 --> |"No"| D6["üìã Check Logs"]
    end

    style B1 fill:#e1bee7,stroke:#7b2cbf,color:#000
    style B3 fill:#e0f2f1,stroke:#009688,color:#000
    style P2 fill:#fce4ec,stroke:#e91e63,color:#000
    style D5 fill:#c8e6c9,stroke:#4caf50,color:#000
            </div>
        </div>

        <!-- 5. Docker Flow -->
        <div class="section" id="docker-flow">
            <h2><span class="emoji">üê≥</span> Docker Container Flow</h2>
            <p class="description">
                How Docker images flow from build to running containers.
            </p>
            <div class="mermaid">
flowchart LR
    subgraph SOURCE ["Source"]
        S1["üìÅ ml_api/\n‚îú‚îÄ‚îÄ app.py\n‚îú‚îÄ‚îÄ model.py\n‚îú‚îÄ‚îÄ Dockerfile\n‚îî‚îÄ‚îÄ requirements.txt"]
    end

    subgraph BUILD ["Build"]
        S1 --> B1["üî® docker build"]
        B1 --> B2["Layer 1: python:3.11-slim"]
        B2 --> B3["Layer 2: pip install"]
        B3 --> B4["Layer 3: COPY source"]
        B4 --> B5["üì¶ Image\n~500MB"]
    end

    subgraph REGISTRY ["Registry"]
        B5 --> R1["üì§ push"]
        R1 --> R2["üóÑÔ∏è localhost:5050\n/ml-api:latest"]
    end

    subgraph RUNTIME ["Runtime"]
        R2 --> RT1["üì• pull"]
        RT1 --> RT2["üèÉ Container\nRunning"]
        RT2 --> RT3["üåê :8000\nExposed"]
    end

    style S1 fill:#e1bee7,stroke:#7b2cbf,color:#000
    style B5 fill:#e0f2f1,stroke:#009688,color:#000
    style R2 fill:#fff3e0,stroke:#ff9800,color:#000
    style RT3 fill:#c8e6c9,stroke:#4caf50,color:#000
            </div>
        </div>

        <!-- 6. Monitoring Stack -->
        <div class="section" id="monitoring">
            <h2><span class="emoji">üìä</span> Monitoring Stack</h2>
            <p class="description">
                Prometheus collects metrics, Grafana displays them. The ML API exposes metrics at /metrics endpoint.
            </p>
            <div class="mermaid">
flowchart TB
    subgraph APP ["ML API (:8000)"]
        A1["POST /predict"] --> A2["ü§ñ Iris Classifier"]
        A2 --> A3["üìä Update Metrics"]
        A3 --> A4["/metrics endpoint"]
    end

    subgraph METRICS ["Metrics Exposed"]
        A4 --> M1["http_requests_total\n(Counter)"]
        A4 --> M2["ml_predictions_total\n(Counter)"]
        A4 --> M3["prediction_latency_seconds\n(Histogram)"]
        A4 --> M4["model_accuracy\n(Gauge)"]
    end

    subgraph PROM ["Prometheus (:9090)"]
        M1 --> P1["‚è±Ô∏è Scrape every 15s"]
        M2 --> P1
        M3 --> P1
        M4 --> P1
        P1 --> P2["üíæ Time Series DB"]
        P2 --> P3["üîç PromQL Queries"]
    end

    subgraph GRAF ["Grafana (:3000)"]
        P3 --> G1["üìà Dashboards"]
        G1 --> G2["Request Rate"]
        G1 --> G3["Latency P99"]
        G1 --> G4["Predictions/Class"]
        G1 --> G5["Error Rate"]
    end

    style A1 fill:#e3f2fd,stroke:#2196f3,color:#000
    style P2 fill:#fce4ec,stroke:#e91e63,color:#000
    style G1 fill:#e8f5e9,stroke:#4caf50,color:#000
            </div>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant API as ML API
    participant Prom as Prometheus
    participant Graf as Grafana

    Client->>API: POST /predict
    API->>API: Make prediction
    API->>API: Update metrics counters
    API-->>Client: Response (class, confidence)

    loop Every 15 seconds
        Prom->>API: GET /metrics
        API-->>Prom: Prometheus format metrics
        Prom->>Prom: Store in time series DB
    end

    Graf->>Prom: PromQL query
    Prom-->>Graf: Time series data
    Graf->>Graf: Render dashboard
            </div>
        </div>

        <!-- 7. Key Concepts -->
        <div class="section" id="concepts">
            <h2><span class="emoji">üìö</span> Key Concepts</h2>
            <div class="concept-grid">
                <div class="concept-card">
                    <h3>üîÑ CI (Continuous Integration)</h3>
                    <p>Automatically verify code quality on every change. Run linters, tests, and static analysis to catch issues early.</p>
                </div>
                <div class="concept-card">
                    <h3>üöÄ CD (Continuous Deployment)</h3>
                    <p>Automatically deploy tested code to production. Build artifacts, push to registry, deploy to servers.</p>
                </div>
                <div class="concept-card">
                    <h3>üê≥ Docker</h3>
                    <p>Package applications with all dependencies into portable containers. "Build once, run anywhere."</p>
                </div>
                <div class="concept-card">
                    <h3>üì¶ Container Registry</h3>
                    <p>Storage for Docker images. Like GitHub for containers. Examples: Docker Hub, ECR, local registry.</p>
                </div>
                <div class="concept-card">
                    <h3>üéº Docker Compose</h3>
                    <p>Define and run multi-container applications. One YAML file describes your entire stack.</p>
                </div>
                <div class="concept-card">
                    <h3>üìä Prometheus</h3>
                    <p>Time-series database for metrics. Scrapes /metrics endpoints and stores data for querying.</p>
                </div>
                <div class="concept-card">
                    <h3>üìà Grafana</h3>
                    <p>Visualization platform. Creates dashboards from Prometheus data. Alerts, graphs, panels.</p>
                </div>
                <div class="concept-card">
                    <h3>üè• Health Checks</h3>
                    <p>Endpoints that report service health. Used by orchestrators to know when containers are ready.</p>
                </div>
            </div>
        </div>

        <!-- Commands Reference -->
        <div class="section">
            <h2><span class="emoji">‚å®Ô∏è</span> Quick Command Reference</h2>
            <div class="mermaid">
flowchart LR
    subgraph COMMANDS ["Makefile Commands"]
        C1["make help"] --> C1D["Show all commands"]
        C2["make ci"] --> C2D["Run lint + test"]
        C3["make build"] --> C3D["Build Docker image"]
        C4["make push"] --> C4D["Push to registry"]
        C5["make deploy"] --> C5D["Deploy containers"]
        C6["make all"] --> C6D["Full pipeline"]
        C7["make status"] --> C7D["Show service status"]
        C8["make logs"] --> C8D["View logs"]
        C9["make clean"] --> C9D["Stop everything"]
    end

    style C6 fill:#c8e6c9,stroke:#4caf50,color:#000
    style C6D fill:#c8e6c9,stroke:#4caf50,color:#000
            </div>
        </div>

    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#1a1a2e',
                primaryTextColor: '#e0e0e0',
                primaryBorderColor: '#00d4ff',
                lineColor: '#00d4ff',
                secondaryColor: '#16213e',
                tertiaryColor: '#0f3460',
                fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                mirrorActors: false
            }
        });
    </script>
</body>
</html>
