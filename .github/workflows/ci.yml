# =============================================================================
# GitHub Actions CI/CD Pipeline
# =============================================================================
#
# GITHUB ACTIONS BASICS:
# ----------------------
# GitHub Actions is GitHub's built-in CI/CD system.
# Workflows are defined in YAML files in .github/workflows/
#
# KEY CONCEPTS:
# - Workflow: Automated process defined in YAML
# - Event: What triggers the workflow (push, PR, schedule, etc.)
# - Job: A set of steps that run on the same runner
# - Step: Individual task (run command, use action, etc.)
# - Runner: Virtual machine that executes jobs
# - Action: Reusable unit of code (e.g., actions/checkout)
#
# WORKFLOW STRUCTURE:
# 1. Name and triggers (on:)
# 2. Jobs to run
# 3. Steps within each job
#
# =============================================================================

# Workflow name (shows in GitHub UI)
name: CI Pipeline

# -----------------------------------------------------------------------------
# TRIGGERS
# -----------------------------------------------------------------------------
# When should this workflow run?
on:
  # Run on push to main branch
  push:
    branches:
      - main
      - master

  # Run on pull requests to main branch
  pull_request:
    branches:
      - main
      - master

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# -----------------------------------------------------------------------------
# JOBS
# -----------------------------------------------------------------------------
jobs:

  # ---------------------------------------------------------------------------
  # JOB 1: Lint - Check code style
  # ---------------------------------------------------------------------------
  lint:
    name: üîç Lint Code
    runs-on: ubuntu-latest  # Use latest Ubuntu runner

    steps:
      # Step 1: Checkout code
      # actions/checkout is an official action that clones your repo
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      # actions/setup-python configures Python on the runner
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache pip dependencies for faster builds
          cache-dependency-path: 'ml_api/requirements.txt'

      # Step 3: Install linting tools
      - name: Install linting tools
        run: pip install ruff

      # Step 4: Run ruff linter
      # ruff is a fast Python linter (replaces flake8, isort, etc.)
      - name: Run Ruff linter
        run: |
          cd ml_api
          ruff check . --output-format=github

      # Step 5: Check formatting with ruff
      - name: Check formatting
        run: |
          cd ml_api
          ruff format --check .

  # ---------------------------------------------------------------------------
  # JOB 2: Test - Run unit tests
  # ---------------------------------------------------------------------------
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    # Run after lint job succeeds
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ml_api/requirements.txt'

      # Install all dependencies (not just test dependencies)
      - name: Install dependencies
        run: |
          cd ml_api
          pip install -r requirements.txt

      # Run pytest with coverage
      - name: Run tests with coverage
        run: |
          cd ml_api
          pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=term-missing

      # Upload coverage report (optional, for coverage services like Codecov)
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ml_api/coverage.xml
        if: always()  # Upload even if tests fail

  # ---------------------------------------------------------------------------
  # JOB 3: Build - Build Docker image
  # ---------------------------------------------------------------------------
  build:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs: test  # Run after tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build the Docker image
      # We're not pushing to a registry, just validating it builds
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./ml_api
          push: false  # Don't push, just build
          tags: ml-api:${{ github.sha }}
          # Cache layers for faster rebuilds
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # JOB 4: Integration Test - Test the full stack
  # ---------------------------------------------------------------------------
  integration:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: build  # Run after Docker build succeeds

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Start all services with Docker Compose
      - name: Start services
        run: |
          docker-compose up -d --build
          # Wait for services to be ready
          echo "Waiting for services to start..."
          sleep 30

      # Check ML API health
      - name: Check ML API health
        run: |
          curl --fail http://localhost:8000/health || exit 1

      # Make a test prediction
      - name: Test prediction endpoint
        run: |
          response=$(curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"sepal_length": 5.1, "sepal_width": 3.5, "petal_length": 1.4, "petal_width": 0.2}')
          echo "Response: $response"
          # Check that response contains expected fields
          echo "$response" | grep -q "predicted_class" || exit 1

      # Check Prometheus is scraping
      - name: Check Prometheus targets
        run: |
          curl --fail http://localhost:9090/-/healthy || exit 1
          # Give Prometheus time to scrape
          sleep 10
          # Check that ml-api target exists
          targets=$(curl -s http://localhost:9090/api/v1/targets)
          echo "Targets: $targets"

      # Check Grafana is running
      - name: Check Grafana health
        run: |
          curl --fail http://localhost:3000/api/health || exit 1

      # Check metrics endpoint
      - name: Check metrics endpoint
        run: |
          metrics=$(curl -s http://localhost:8000/metrics)
          echo "Metrics (first 50 lines):"
          echo "$metrics" | head -50
          # Verify our custom metrics exist
          echo "$metrics" | grep -q "ml_predictions_total" || echo "Warning: ml_predictions_total not found"
          echo "$metrics" | grep -q "http_requests_total" || echo "Warning: http_requests_total not found"

      # Show logs on failure
      - name: Show logs on failure
        if: failure()
        run: |
          docker-compose logs

      # Clean up
      - name: Stop services
        if: always()
        run: |
          docker-compose down -v

# =============================================================================
# OPTIONAL: Add these sections for more advanced CI/CD
# =============================================================================

# PUSH TO REGISTRY (uncomment and configure):
#
#   push:
#     name: üì¶ Push to Registry
#     runs-on: ubuntu-latest
#     needs: integration
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}
#
#       - name: Build and push
#         uses: docker/build-push-action@v5
#         with:
#           context: ./ml_api
#           push: true
#           tags: |
#             yourusername/ml-api:latest
#             yourusername/ml-api:${{ github.sha }}

# DEPLOYMENT (uncomment and configure):
#
#   deploy:
#     name: üöÄ Deploy
#     runs-on: ubuntu-latest
#     needs: push
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
#     steps:
#       - name: Deploy to server
#         run: |
#           # SSH to server and pull new image
#           # Or trigger Kubernetes deployment
#           # Or update AWS ECS service
#           echo "Deployment step would go here"
